# ðŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚¬ã‚¤ãƒ‰

AIkougiã‚·ã‚¹ãƒ†ãƒ ã®ç’°å¢ƒç®¡ç†ã¨ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †æ›¸

## ðŸ“š ç›®æ¬¡

- [ç’°å¢ƒæ§‹æˆ](#ç’°å¢ƒæ§‹æˆ)
- [é–‹ç™ºãƒ•ãƒ­ãƒ¼](#é–‹ç™ºãƒ•ãƒ­ãƒ¼)
- [ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †](#ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †)
- [ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—](#ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—)
- [ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°](#ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°)

---

## ðŸ—ï¸ ç’°å¢ƒæ§‹æˆ

### ç’°å¢ƒã®ç¨®é¡ž

| ç’°å¢ƒ | ç”¨é€” | ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ | URL |
|------|------|------------|-----|
| **ãƒ­ãƒ¼ã‚«ãƒ«** | é–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆ | aikougi-development (local) | http://localhost:3000 |
| **é–‹ç™ºç’°å¢ƒ** | ãƒªãƒ¢ãƒ¼ãƒˆé–‹ç™º | aikougi-development (remote) | https://dev.aikougi.pages.dev |
| **æœ¬ç•ªç’°å¢ƒ** | é¡§å®¢åˆ©ç”¨ | aikougi-production (remote) | https://aikougi.pages.dev |

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®š

```jsonc
// wrangler.jsonc
{
  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆé–‹ç™ºç’°å¢ƒï¼‰
  "d1_databases": [
    {
      "binding": "DB",
      "database_name": "aikougi-development",
      "database_id": "7309601f-8a81-49d7-813b-9a0e6fc17030"
    }
  ],
  
  // æœ¬ç•ªç’°å¢ƒ
  "env": {
    "production": {
      "d1_databases": [
        {
          "binding": "DB",
          "database_name": "aikougi-production",
          "database_id": "cf8e5dad-0a18-45fc-9698-321e1bffb1ff"
        }
      ]
    }
  }
}
```

---

## ðŸ”„ é–‹ç™ºãƒ•ãƒ­ãƒ¼

### 1. ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™º

```bash
# ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm install

# ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
npm run db:reset:local

# é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•ï¼ˆPM2ä½¿ç”¨ï¼‰
npm run build
pm2 start ecosystem.config.cjs

# åˆ¥ã®æ–¹æ³•ï¼šç›´æŽ¥èµ·å‹•
npm run dev:local
```

### 2. æ–°æ©Ÿèƒ½ã®é–‹ç™º

```bash
# 1. æ©Ÿèƒ½ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ
git checkout -b feature/new-feature

# 2. ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´

# 3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å¤‰æ›´ãŒå¿…è¦ãªå ´åˆ
# migrations/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«æ–°ã—ã„ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
# ä¾‹: migrations/0005_add_new_feature.sql

# 4. ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ†ã‚¹ãƒˆ
npm run db:migrate:local

# 5. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ†ã‚¹ãƒˆ
npm run build
pm2 restart aikougi-dev
curl http://localhost:3000

# 6. å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
git add .
git commit -m "Add new feature"
```

### 3. ãƒžãƒ¼ã‚¸å‰ã®ãƒã‚§ãƒƒã‚¯

```bash
# ãƒ“ãƒ«ãƒ‰ãŒæˆåŠŸã™ã‚‹ã‹ç¢ºèª
npm run build

# ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
npm run db:migrate:check

# æœ¬ç•ªç’°å¢ƒã¸ã®å½±éŸ¿ã‚’ç¢ºèª
./scripts/migrate-check.sh
```

---

## ðŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †

### æ–¹æ³•1: å®‰å…¨ãªè‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆæŽ¨å¥¨ï¼‰

```bash
# æœ¬ç•ªç’°å¢ƒã¸ã®å®Œå…¨è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— â†’ ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ â†’ ãƒ“ãƒ«ãƒ‰ â†’ ãƒ‡ãƒ—ãƒ­ã‚¤
npm run deploy:prod
```

ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ä»¥ä¸‹ã‚’è‡ªå‹•å®Ÿè¡Œã—ã¾ã™ï¼š
1. âœ… æœ¬ç•ªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
2. âœ… ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®é©ç”¨
3. âœ… ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ“ãƒ«ãƒ‰
4. âœ… Cloudflare Pagesã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤

### æ–¹æ³•2: æ‰‹å‹•ãƒ‡ãƒ—ãƒ­ã‚¤

```bash
# Step 1: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
npm run backup:prod

# Step 2: ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨
npm run db:migrate:prod

# Step 3: ãƒ“ãƒ«ãƒ‰ã¨ãƒ‡ãƒ—ãƒ­ã‚¤
npm run build
npx wrangler pages deploy dist --project-name aikougi --branch main
```

### é–‹ç™ºç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤

```bash
# é–‹ç™ºç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸è¦ï¼‰
npm run deploy:dev
```

---

## ðŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—

### è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—

æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«è‡ªå‹•çš„ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒä½œæˆã•ã‚Œã¾ã™ã€‚

```bash
# æ‰‹å‹•ã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆ
npm run backup:prod
```

### ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´æ‰€

```
backups/
  â”œâ”€â”€ aikougi-production_20250113_143022.sql
  â”œâ”€â”€ aikougi-production_20250114_095511.sql
  â””â”€â”€ .last_backup
```

### ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ä¿æŒæœŸé–“

- **è‡ªå‹•å‰Šé™¤**: 30æ—¥ä»¥ä¸Šå‰ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã¯è‡ªå‹•å‰Šé™¤ã•ã‚Œã¾ã™
- **æ‰‹å‹•ç®¡ç†**: é‡è¦ãªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¯åˆ¥ã®å ´æ‰€ã«ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„

### ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒ

```bash
# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å¾©å…ƒ
npx wrangler d1 execute aikougi-production --remote --file=./backups/aikougi-production_YYYYMMDD_HHMMSS.sql
```

---

## ðŸ“Š ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†

### ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ä½œæˆ

```bash
# æ–°ã—ã„ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
# ãƒ•ã‚¡ã‚¤ãƒ«å: migrations/00XX_description.sql

cat > migrations/0005_add_new_table.sql << 'EOF'
-- æ–°ã—ã„ãƒ†ãƒ¼ãƒ–ãƒ«ã®è¿½åŠ 
CREATE TABLE IF NOT EXISTS new_table (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT NOT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
EOF
```

### ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®é©ç”¨

```bash
# ãƒ­ãƒ¼ã‚«ãƒ«ã§é©ç”¨
npm run db:migrate:local

# é–‹ç™ºç’°å¢ƒã§é©ç”¨
npm run db:migrate:dev

# æœ¬ç•ªç’°å¢ƒã§é©ç”¨ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¾Œï¼‰
npm run backup:prod
npm run db:migrate:prod
```

### ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒã‚§ãƒƒã‚¯

```bash
# ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’ç¢ºèª
npm run db:migrate:check

# ã¾ãŸã¯ç›´æŽ¥å®Ÿè¡Œ
./scripts/migrate-check.sh
```

---

## ðŸ” ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œ

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚³ãƒ³ã‚½ãƒ¼ãƒ«

```bash
# ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
npm run db:console:local -- --command="SELECT * FROM users LIMIT 10;"

# é–‹ç™ºç’°å¢ƒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
npm run db:console:dev -- --command="SELECT * FROM users LIMIT 10;"

# æœ¬ç•ªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆæ…Žé‡ã«ï¼ï¼‰
npm run db:console:prod -- --command="SELECT * FROM users LIMIT 10;"
```

### ãƒ‡ãƒ¼ã‚¿ã®ã‚·ãƒ¼ãƒ‰

```bash
# ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã«ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥
npm run db:seed:local

# é–‹ç™ºç’°å¢ƒã«ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥
npm run db:seed:dev
```

âš ï¸ **æ³¨æ„**: æœ¬ç•ªç’°å¢ƒã«ã¯ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ã—ãªã„ã§ãã ã•ã„ï¼

---

## ðŸ› ï¸ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¤±æ•—ã—ãŸå ´åˆ

```bash
# 1. ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèª
npm run deploy:prod

# 2. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒ
npx wrangler d1 execute aikougi-production --remote --file=./backups/aikougi-production_LATEST.sql

# 3. ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ‰‹å‹•ã§ç¢ºèª
npm run db:migrate:check
```

### ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒå¤±æ•—ã—ãŸå ´åˆ

```bash
# 1. æœ€æ–°ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ç¢ºèª
ls -lt backups/

# 2. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒ
npx wrangler d1 execute aikougi-production --remote --file=./backups/aikougi-production_YYYYMMDD_HHMMSS.sql

# 3. ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿®æ­£
vim migrations/00XX_problematic_migration.sql

# 4. å†åº¦é©ç”¨
npm run backup:prod
npm run db:migrate:prod
```

### ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã®ãƒªã‚»ãƒƒãƒˆ

```bash
# ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’å®Œå…¨ãƒªã‚»ãƒƒãƒˆ
npm run db:reset:local

# PM2ã‚’ãƒªã‚»ãƒƒãƒˆ
pm2 delete all
pm2 start ecosystem.config.cjs
```

---

## ðŸ“ ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### ãƒ‡ãƒ—ãƒ­ã‚¤å‰ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] ã‚³ãƒ¼ãƒ‰ã®ãƒ“ãƒ«ãƒ‰ãŒæˆåŠŸã™ã‚‹ï¼ˆ`npm run build`ï¼‰
- [ ] ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã™ã‚‹
- [ ] ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å†…å®¹ã‚’ç¢ºèªã—ãŸï¼ˆ`npm run db:migrate:check`ï¼‰
- [ ] ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒè‡ªå‹•å®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
- [ ] ãƒ‡ãƒ—ãƒ­ã‚¤ã¯å–¶æ¥­æ™‚é–“å¤–ã«å®Ÿæ–½

### ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹
- [ ] ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹
- [ ] æ—¢å­˜ã®é¡§å®¢ãƒ‡ãƒ¼ã‚¿ãŒä¿æŒã•ã‚Œã¦ã„ã‚‹
- [ ] æ–°æ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹
- [ ] ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹

---

## ðŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### ç’°å¢ƒå¤‰æ•°ã®ç®¡ç†

```bash
# ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç”¨ï¼ˆ.dev.varsï¼‰
ENVIRONMENT=development
DEBUG=true

# æœ¬ç•ªç’°å¢ƒç”¨ï¼ˆCloudflare Pagesã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆï¼‰
# Cloudflareãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§è¨­å®š
```

### æœ¬ç•ªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™

âš ï¸ **è­¦å‘Š**: æœ¬ç•ªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®ç›´æŽ¥ã‚¢ã‚¯ã‚»ã‚¹ã¯æ…Žé‡ã«è¡Œã£ã¦ãã ã•ã„

```bash
# èª­ã¿å–ã‚Šã®ã¿æŽ¨å¥¨
npm run db:console:prod -- --command="SELECT COUNT(*) FROM users;"

# ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›´ã¯æ¥µåŠ›é¿ã‘ã‚‹
# ã‚„ã‚€ã‚’å¾—ãªã„å ´åˆã¯å¿…ãšãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–å¾—
npm run backup:prod
```

---

## ðŸ“ž ã‚µãƒãƒ¼ãƒˆ

å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆï¼š

1. ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’ç¢ºèª
2. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªï¼ˆ`backups/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼‰
3. GitHubã®issueã‚’ç¢ºèª
4. ãƒãƒ¼ãƒ å†…ã§ç›¸è«‡

---

## ðŸŽ¯ ã¾ã¨ã‚

### åŸºæœ¬çš„ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

```bash
# 1. ãƒ­ãƒ¼ã‚«ãƒ«ã§é–‹ç™º
npm run build
pm2 start ecosystem.config.cjs

# 2. ãƒ†ã‚¹ãƒˆ
curl http://localhost:3000

# 3. ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆè‡ªå‹•ï¼‰
npm run deploy:prod
```

### ç·Šæ€¥æ™‚ã®å¯¾å¿œ

```bash
# 1. ã™ãã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ç¢ºèª
ls -lt backups/

# 2. æœ€æ–°ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒ
npm run db:console:prod -- --file=./backups/aikougi-production_LATEST.sql

# 3. å¿…è¦ã«å¿œã˜ã¦ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
git revert <commit-hash>
npm run deploy:prod
```

---

**æœ€çµ‚æ›´æ–°æ—¥**: 2025-11-13
